## Working With DynamoDB

#### 1. Add dependency
```
<dependency>
    <groupId>com.amazonaws</groupId>
    <artifactId>aws-java-sdk-dynamodb</artifactId>
    <version>1.12.429</version>
</dependency>
```

#### 2. Config connection DynamoDB

- Update application-*.yml
```
amazon:
  dynamodb:
    endpoint: ${AMAZON_DYNAMODB_ENDPOINT}
    region: ${AMAZON_DYNAMODB_REGION}
    accessKey: ${AMAZON_DYNAMODB_ACCESS_KEY}
    secretKey: ${AMAZON_DYNAMODB_SECRET_KEY}
```

- Create file `DynamoDBConfig`
```
@Configuration
public class DynamoDBConfig {

    @Value("${amazon.dynamodb.endpoint}")
    private String amazonDynamoDBEndpoint;

    @Value("${amazon.dynamodb.region}")
    private String amazonDynamoDBRegion;

    @Value("${amazon.dynamodb.accessKey}")
    private String amazonAWSAccessKey;

    @Value("${amazon.dynamodb.secretKey}")
    private String amazonAWSSecretKey;

    @Value("${spring.profiles.active:Unknown}")
    private String activeProfile;

    @Bean
    public DynamoDBMapper dynamoDBMapper() {
        return new DynamoDBMapper(buildAmazonDB(), dynamoDBMapperConfig());
    }

    private AmazonDynamoDB buildAmazonDB() {
        return AmazonDynamoDBClientBuilder.standard()
                .withEndpointConfiguration(new AwsClientBuilder.EndpointConfiguration(amazonDynamoDBEndpoint, amazonDynamoDBRegion))
                .withCredentials(new AWSStaticCredentialsProvider(new BasicAWSCredentials(amazonAWSAccessKey, amazonAWSSecretKey))).build();
    }

    @Bean
    DynamoDBMapperConfig dynamoDBMapperConfig() {
        String prefix = "";
        if (activeProfile.equals("prod")) {
            prefix = "PROD_";
        }
        return new DynamoDBMapperConfig.Builder()
                .withTableNameOverride(DynamoDBMapperConfig.TableNameOverride.withTableNamePrefix(prefix))
                .build();
    }
}
```

### 3. Create an API

#### 3.1 Create model

```
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@DynamoDBTable(tableName = "sample_user")
public class SampleUser {

    @DynamoDBHashKey
    @DynamoDBIndexHashKey(globalSecondaryIndexNames = {FIRST_NAME})
    private String hashKey;
    @DynamoDBRangeKey
    @DynamoDBAutoGeneratedKey
    private String rangeKey;

    @DynamoDBAttribute
    @DynamoDBIndexRangeKey(globalSecondaryIndexName = FIRST_NAME)
    private String firstName;

    @DynamoDBAttribute
    private String lastName;

    @DynamoDBAttribute
    @DynamoDBIndexHashKey(globalSecondaryIndexName = PHONE)
    private String phone;

    @DynamoDBAttribute
    @DynamoDBIndexHashKey(globalSecondaryIndexName = EMAIL)
    private String email;

    @DynamoDBAttribute
    private String password;

    @DynamoDBAttribute
    @DynamoDBTyped(DynamoDBMapperFieldModel.DynamoDBAttributeType.M)
    private Address address;

    @DynamoDBAttribute
    @DynamoDBTypeConvertedEnum
    private UserStatus status;

    @DynamoDBAttribute
    private String searchKeys;

    @DynamoDBAttribute
    @DynamoDBTyped(DynamoDBMapperFieldModel.DynamoDBAttributeType.BOOL)
    private Boolean isFirstLogin;

    @DynamoDBAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.CREATE)
    @DynamoDBTypeConvertedTimestamp(pattern = DD_M_YYYY_HH_MM_SS, timeZone = "GTM")
    private Date createdAt;

    @DynamoDBAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.ALWAYS)
    @DynamoDBTypeConvertedTimestamp(pattern = YYYY_MM_DD_HH_MM_SS, timeZone = "UTC")
    private Date updatedAt;
}
```

### 3.2  Create repository

```
@Repository
@Slf4j(topic = "SAMPLE-USER-REPOSITORY")
public class SampleUserRepository {

    @Autowired
    private DynamoDBMapper dynamoDBMapper;

    /**
     * Save sample user to dynamodb
     *
     * @param object
     * @return
     */
    public SampleUser save(SampleUser object) {
        log.info("Saving sample user, object={}",object);

        dynamoDBMapper.save(object);
        log.info("Sample user has saved");
        return object;
    }
    ...
}
```

### 3.3  Create service

```
@Service
@Slf4j(topic = "SAMPLE-USER-SERVICE")
public record SampleUserService(SampleUserRepository repository, KafkaTemplate<String, String> kafkaTemplate, PasswordEncoder passwordEncoder) {

    /**
     * Add new sample user
     *
     * @param request
     * @return
     */
    public String saveSampleUser(SampleUserRequest request) {
        log.info("Saving sample user ...");

        String searchKeys = String.format("%s %s, %s, %s, %s", request.getFirstName(), request.getLastName(), request.getPhone(), request.getEmail(), request.getAddress());
        SampleUser object = SampleUser.builder()
                .hashKey("uuid")
                .firstName(request.getFirstName())
                .lastName(request.getLastName())
                .phone(request.getPhone())
                .email(request.getEmail())
                .password(passwordEncoder().encode(request.getPassword()))
                .address(request.getAddress())
                .status(UserStatus.NONE)
                .isFirstLogin(true)
                .searchKeys(searchKeys)
                .build();

        SampleUser response = repository.save(object);

        return response.getRangeKey();
    }
    ...
}

```


### 3.4  Create controller

- Create request form
```
@Data
public class SampleUserRequest implements Serializable {
    private String rangeKey;

    @NotBlank(message = "{msg-validate-firstName}")
    private String firstName;

    @NotBlank(message = "{msg-validate-lastName}")
    private String lastName;

    @NotBlank(message = "{msg-validate-phone}")
    private String phone;

    @NotBlank(message = "{msg-validate-email}")
    private String email;

    @NotBlank(message = "{msg-validate-password}")
    private String password;

    @NotNull(message = "{msg-validate-address}")
    private Address address;
}
```

- Create new API

```
@RestController
@RequestMapping("/samples")
@Slf4j(topic = "SAMPLE-CONTROLLER")
public record SampleController(SampleUserService userService) {

    @PostMapping(path = "/user/add", headers = apiKey)
    public SuccessResponse createSampleUser(@Validated @RequestBody SampleUserRequest request) {
        log.info("Request POST /user/add");

        try {
            userService.isPhoneValid(request.getPhone());
            userService.isEmailValid(request.getEmail());

            String id = userService.saveSampleUser(request);
            return new SuccessResponse(CREATED, Translator.toLocale("msg-user-add-success"), id);
        } catch (Exception e) {
            log.error("Add new user was failure, message={}", e.getMessage(), e);
            return new FailureResponse(BAD_REQUEST, Translator.toLocale("msg-user-add-failure"));
        }
    }
    ...
}
```

### 4. Test

```
curl --location 'http://localhost:8181/samples/user/add' \
--header 'Accept-Language: en-US' \
--header 'apiKey: sample' \
--data-raw '{
    "firstName": "John",
    "lastName": "Doe",
    "phone": "0123456789",
    "email": "johndoe@email.com",
    "password": "password",
    "address": {
        "street": "Ciputra",
        "district": "North Tu Liem",
        "city": "Hanoi",
        "country": "Vietnam",
        "postalCode": "100000",
        "text": "S2-100"
    }
}'
```
